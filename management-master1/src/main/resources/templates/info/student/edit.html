<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改学生')" />
    <th:block th:include="include :: bootstrap-select-css" />
</head>
<body>
<div class="main-content">
    <form id="form-user-edit" class="form-horizontal">
        <input name="address" type="hidden" id="address"/>
        <input name="Id" id="Id" type="hidden"  th:value="${student.Id}" />
        <h4 class="form-header h4">基本信息</h4>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：</label>
                    <div class="col-sm-8">
                        <input id="userName" name="userName" placeholder="请输入姓名" class="form-control" th:value="${student.userName}" type="text" maxlength="30" required>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">身份证号：</label>
                    <div class="col-sm-8">
                        <input id="idNumber" name="idNumber" placeholder="请输入身份证号" class="form-control" th:value="${student.idNumber}" type="text" required>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">电子邮箱：</label>
                    <div class="col-sm-8">
                        <input id="email" name="email" class="form-control email" th:value="${student.email}" type="text" maxlength="20" placeholder="请输入邮箱">
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">手机号码：</label>
                    <div class="col-sm-8">
                        <input id="phoneNumber" name="phoneNumber" placeholder="请输入手机号码" class="form-control" th:value="${student.phoneNumber}" type="text" maxlength="11">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">用户性别：</label>
                    <div class="col-sm-8">
                        <select name="sex" class="form-control m-b" required>
                            <option value="0" th:selected="${student.sex == '0' ? true : false}">男</option>
                            <option value="1" th:selected="${student.sex == '1' ? true : false}">女</option>
                            <option value="2" th:selected="${student.sex == '2' ? true : false}">未知</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">家庭住址：</label>
                    <div class="col-xs-10">
                        <label>
                            <select name="province" id="province" class="form-control m-b address">
                            </select>
                        </label>
                        <label>
                            <select name="city" id="city" class="form-control m-b address">
                            </select>
                        </label>
                        <label>
                            <select name="area" id="area" class="form-control m-b address">
                            </select>
                        </label>
                        <label>
                            <select name="street" id="street" class="form-control m-b address">
                            </select>
                        </label>
                        <label>
                            <select name="villages" id="villages" class="form-control m-b address">
                            </select>
                        </label>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<th:block th:include="include :: footer" />
<th:block th:include="include :: bootstrap-select-js" />
<script th:inline="javascript">
    var prefix = ctx + "info/student";

    var address = [[${student.addressParentIds}]].split(',');
    var selects = [
        {id: "city", text: "请选择市"}, {id: "area", text: "请选择县/区"},{id: "street", text: "请选择镇/乡"},
        {id: "villages", text: "请选择村"},
    ];

    $(function () {
        clearSelect(address.length - 1);
        $(".address").selectpicker({
            "width": 200,
            "virtualScroll": 10,
            "liveSearch": true,
            "size": 10
        });
        $(function () { $("[data-toggle='tooltip']").tooltip(); });
        selectRender("province", 0, address.length > 1 ? address[1] : address.length == 1 ? [[${student.address}]] : '');
        initSelect();
    });

    function initSelect() {
        for(var i = 1; i < address.length; i++){
            selectRender(selects[i-1].id, address[i], (i == address.length - 1) ? [[${student.address}]] : address[i+1]);
        }
        if(address.length < 5 ){
            selectRender(selects[address.length - 1].id, [[${student.address}]], '');
        }
    }

    function clearSelect(num) {
        for(var i = num; i < selects.length; i++){
            var _this = $("#" + selects[i].id);
            _this.html("");
            _this.append("<option value='' selected>" + selects[i].text + "</option>");
            _this.selectpicker("refresh");
        }
    }

    function selectRender(id, addressId, selectedId) {
        if($.common.isEmpty(addressId)){
            return ;
        }
        var _this = $("#" + id);
        $.post(ctx + "address/selectProvince/" + addressId, function(data){
            for(var i=0; i< data.length;i++){
                var selected = selectedId == data[i].addressId ? " selected='selected' " : "";
                _this.append("<option value='"+data[i].addressId+ "'" + selected + ">"+data[i].addressName+"</option>");
            }
            _this.selectpicker("refresh");
        });
    }

    $('#province').on('changed.bs.select', function () {
        clearSelect(0);
        selectRender("city", $("#province option:selected").val());
    });
    $('#city').on('changed.bs.select', function () {
        clearSelect(1);
        selectRender("area", $("#city option:selected").val());
    });
    $('#area').on('changed.bs.select', function () {
        clearSelect(2);
        selectRender("street", $("#area option:selected").val());
    });
    $('#street').on('changed.bs.select', function () {
        clearSelect(3);
        selectRender("villages", $("#street option:selected").val());
    });

    $("#form-user-edit").validate({
        onkeyup: false,
        rules:{
            email:{
                email:true
            },
            phoneNumber:{
                isPhone:true
            },
            // idNumber:{
            //     isIdentity:true,
            //     minlength: 15,
            //     maxlength: 18,
            //     remote: {
            //         url: prefix + "/checkIdNumberUnique",
            //         type: "post",
            //         dataType: "json",
            //         data: {
            //             "idNumber": function() {
            //                 return $.common.trim($("#idNumber").val());
            //             }
            //         },
            //         dataFilter: function(data, type) {
            //             return $.validate.unique($.common.trim($("#idNumber").val()) == [[${student.idNumber}]] ? 0 : data);
            //         }
            //     }
            // }
        },
        messages: {
            "idNumber": {
                remote: "该学生信息已在库"
            }
        },
        focusCleanup: true
    });

    function submitHandler() {
        var addressIds = ["#villages", "#street", "#area","#city", "#province"]
        for(var i=0; i < addressIds.length; i++){
            if($.common.isNotEmpty($(addressIds[i] + " option:selected").val())){
                $("#address").val($(addressIds[i] + " option:selected").val());
                break;
            }
        }

        if ($.validate.form()) {
            $.operate.save(ctx + "info/student/update", $('#form-user-edit').serialize());
        }
    }

</script>
</body>
</html>