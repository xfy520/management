<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('用户个人信息')"/>
    <th:block th:include="include :: bootstrap-select-css" />
</head>

<body class="gray-bg"
      style="font: 14px Helvetica Neue, Helvetica, PingFang SC, 微软雅黑, Tahoma, Arial, sans-serif !important;">
<input id="userId" name="userId" type="hidden" th:value="${user.userId}"/>
<section class="section-content">
    <div class="row">
        <div class="col-sm-3 pr5">
            <div class="ibox float-e-margins">
                <div class="ibox-title ibox-title-gray dashboard-header gray-bg">
                    <h5>个人资料</h5>
                </div>
                <div class="ibox-content">
                    <div class="text-center">
                        <p><img th:src="(${session.avatar} != '') ? (@{${session.avatar}}) : (@{/img/profile.jpg})"
                                class="img-circle" alt="User Image"></p>
                        <p><a href="javascript:avatar()">修改头像</a></p>
                    </div>
                    <ul class="list-group list-group-striped">
                        <li class="list-group-item"><i class="fa fa-user"></i>
                            <b class="font-noraml">登录账号：</b>
                            <p class="pull-right">[[${user.userId}]]</p>
                        </li>
                        <li class="list-group-item"><i class="fa fa-user"></i>
                            <b class="font-noraml">姓名：</b>
                            <p class="pull-right">[[${user.userName}]]</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-sm-9 about">
            <div class="ibox float-e-margins">
                <div class="ibox-title ibox-title-gray dashboard-header">
                    <h5>基本资料</h5>
                </div>
                <div class="ibox-content">
                    <div class="nav-tabs-custom">
                        <ul class="nav nav-tabs">
                            <li th:if="${session.perms} == 3" class="active"><a href="#user_info" data-toggle="tab"
                                                                                th:aria-expanded="${session.perms} == 3">基本资料</a>
                            </li>
                            <li th:class="${session.perms} < 3 ? active : ''"><a href="#modify_password"
                                                                                 data-toggle="tab"
                                                                                 th:aria-expanded="${session.perms} == 3">修改密码</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <!--用户信息-->
                            <div th:if="${session.perms} == 3" class="tab-pane active" id="user_info"
                                 th:object="${user}">
                                <form class="form-horizontal" id="form-user-edit">
                                    <!--隐藏ID-->
                                    <input name="address" type="hidden" id="address"/>
                                    <input name="Id" id="Id" type="hidden"  th:value="${user.Id}" />
                                    <div th:if="${session.perms} == 3" class="form-group">
                                        <label class="col-sm-2 control-label">手机号码：</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" name="phoneNumber" id="phoneNumber" maxlength="11"
                                                   th:field="*{phoneNumber}" placeholder="请输入手机号码">
                                        </div>
                                    </div>
                                    <div th:if="${session.perms} == 3" class="form-group">
                                        <label class="col-sm-2 control-label">邮箱：</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" name="email" id="email" th:field="*{email}"
                                                   placeholder="请输入邮箱">
                                        </div>
                                    </div>
                                    <div th:if="${session.perms} == 3" class="form-group">
                                        <label class="col-sm-2 control-label">性别：</label>
                                        <div class="col-sm-10">
                                            <div class="radio-box">
                                                <input type="radio" id="radio1" th:field="*{sex}" name="sex" value="0">
                                                <label for="radio1">男</label>
                                            </div>
                                            <div class="radio-box">
                                                <input type="radio" id="radio2" th:field="*{sex}" name="sex" value="1">
                                                <label for="radio2">女</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">家庭住址：</label>
                                        <div class="col-xs-10">
                                            <label>
                                                <select name="province" id="province" class="form-control m-b address">
                                                </select>
                                            </label>
                                            <label>
                                                <select name="city" id="city" class="form-control m-b address">
                                                </select>
                                            </label>
                                            <label>
                                                <select name="area" id="area" class="form-control m-b address">
                                                </select>
                                            </label>
                                            <label>
                                                <select name="street" id="street" class="form-control m-b address">
                                                </select>
                                            </label>
                                            <label>
                                                <select name="villages" id="villages" class="form-control m-b address">
                                                </select>
                                            </label>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-offset-2 col-sm-10">
                                            <button type="button" class="btn btn-sm btn-primary"
                                                    onclick="submitUserInfo()"><i class="fa fa-check"></i>保 存
                                            </button>&nbsp;
                                            <button type="button" class="btn btn-sm btn-danger" onclick="closeItem()"><i
                                                    class="fa fa-reply-all"></i>关 闭
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!--修改密码-->
                            <div class="tab-pane" th:classappend="${session.perms} < 3 ? active : ''"
                                 id="modify_password">
                                <form class="form-horizontal" id="form-user-resetPwd">
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">旧密码：</label>
                                        <div class="col-sm-10">
                                            <input type="password" class="form-control" name="oldPassword"
                                                   placeholder="请输入旧密码">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">新密码：</label>
                                        <div class="col-sm-10">
                                            <input type="password" class="form-control" name="newPassword"
                                                   id="newPassword" placeholder="请输入新密码">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">确认密码：</label>
                                        <div class="col-sm-10">
                                            <input type="password" class="form-control" name="confirmPassword"
                                                   placeholder="请确认密码">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-offset-2 col-sm-10">
                                            <button type="button" class="btn btn-sm btn-primary"
                                                    onclick="submitChangPassword()"><i class="fa fa-check"></i>保 存
                                            </button>&nbsp;
                                            <button type="button" class="btn btn-sm btn-danger" onclick="closeItem()"><i
                                                    class="fa fa-reply-all"></i>关 闭
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<th:block th:include="include :: footer"/>
<th:block th:include="include :: bootstrap-select-js" />
<script th:inline="javascript">

    if([[${session.perms}]] == 3){
        var address = [[${user.addressParentIds}]].split(',');
        var selects = [
            {id: "city", text: "请选择市"}, {id: "area", text: "请选择县/区"},{id: "street", text: "请选择镇/乡"},
            {id: "villages", text: "请选择村"},
        ];

        $(function () {
            clearSelect(address.length - 1);
            $(".address").selectpicker({
                "width": 200,
                "virtualScroll": 10,
                "liveSearch": true,
                "size": 10
            });
            $(function () { $("[data-toggle='tooltip']").tooltip(); });
            selectRender("province", 0, address.length > 1 ? address[1] : address.length == 1 ? [[${user.address}]] : '');
            initSelect();
        });

        function initSelect() {
            for(var i = 1; i < address.length; i++){
                selectRender(selects[i-1].id, address[i], (i == address.length - 1) ? [[${user.address}]] : address[i+1]);
            }
            if(address.length < 5 ){
                selectRender(selects[address.length - 1].id, [[${user.address}]], '');
            }
        }

        function clearSelect(num) {
            for(var i = num; i < selects.length; i++){
                var _this = $("#" + selects[i].id);
                _this.html("");
                _this.append("<option value=''>" + selects[i].text + "</option>");
                _this.selectpicker("refresh");
            }
        }

        function selectRender(id, addressId, selectedId) {
            if($.common.isEmpty(addressId)){
                return ;
            }
            var _this = $("#" + id);
            $.post(ctx + "address/selectProvince/" + addressId, function(data){
                for(var i=0; i< data.length;i++){
                    var selected = selectedId == data[i].addressId ? " selected='selected' " : "";
                    _this.append("<option value='"+data[i].addressId+ "'" + selected + ">"+data[i].addressName+"</option>");
                }
                _this.selectpicker("refresh");
            });
        }

        $('#province').on('changed.bs.select', function () {
            clearSelect(0);
            selectRender("city", $("#province option:selected").val());
        });
        $('#city').on('changed.bs.select', function () {
            clearSelect(1);
            selectRender("area", $("#city option:selected").val());
        });
        $('#area').on('changed.bs.select', function () {
            clearSelect(2);
            selectRender("street", $("#area option:selected").val());
        });
        $('#street').on('changed.bs.select', function () {
            clearSelect(3);
            selectRender("villages", $("#street option:selected").val());
        });
    }

    /*用户管理-头像*/
    function avatar() {
        var url = ctx + 'user/avatar';
        $.modal.open("修改头像", url);
    }

    /*用户信息-修改*/
    $("#form-user-edit").validate({
        onkeyup: false,
        rules: {
            email: {
                email: true
            },
            phoneNumber: {
                isPhone: true
            },
        },
        messages: {
            "phoneNumber": {
                required: "请输入手机号码",
                remote: "手机号码已经存在"
            }
        },
        focusCleanup: true
    });

    function submitUserInfo() {
        if ($.validate.form()) {
            var addressIds = ["#villages", "#street", "#area","#city", "#province"]
            for(var i=0; i < addressIds.length; i++){
                if($.common.isNotEmpty($(addressIds[i] + " option:selected").val())){
                    $("#address").val($(addressIds[i] + " option:selected").val());
                    break;
                }
            }
            if ($.validate.form()) {
                $.operate.save(ctx + "info/student/update", $('#form-user-edit').serialize());
            }
        }
    }

    /*用户管理-修改密码*/
    $("#form-user-resetPwd").validate({
        onkeyup: false,
        rules: {
            oldPassword: {
                required: true,
                remote: {
                    url: ctx + "user/checkPassword",
                    type: "post",
                    dataType: "json",
                    data: {
                        password: function () {
                            return $("input[name='oldPassword']").val();
                        }
                    },
                    dataFilter: function(data, type) {
                        data = data == 1 ? 0 : 1;
                        return $.validate.unique(data) ;
                    }
                }
            },
            newPassword: {
                required: true,
                minlength: 6,
                maxlength: 20
            },
            confirmPassword: {
                required: true,
                equalTo: "#newPassword"
            }
        },
        messages: {
            oldPassword: {
                required: "请输入原密码",
                remote: "原密码错误"
            },
            newPassword: {
                required: "请输入新密码",
                minlength: "密码不能小于6个字符",
                maxlength: "密码不能大于20个字符"
            },
            confirmPassword: {
                required: "请再次输入新密码",
                equalTo: "两次密码输入不一致"
            }

        },
        focusCleanup: true
    });

    function submitChangPassword() {
        if ($.validate.form("form-user-resetPwd")) {
            $.operate.saveModal(ctx + "user/resetPwd", $('#form-user-resetPwd').serialize());
        }
    }
</script>
</body>
</html>
