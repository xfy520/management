<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('新增学生')" />
    <th:block th:include="include :: bootstrap-select-css" />
</head>
<body>
<div class="main-content">
    <form id="form-user-add" class="form-horizontal">
        <input name="address" type="hidden" id="address"/>
        <h4 class="form-header h4">基本信息</h4>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">登录账号：</label>
                    <div class="col-sm-8">
                        <input id="loginName" name="loginName" placeholder="请输入登录账号" class="form-control" type="text" maxlength="30" required>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">登录密码：</label>
                    <div class="col-sm-8">
                        <input name="password" placeholder="请输入登录密码" class="form-control" type="password"  required>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：</label>
                    <div class="col-sm-8">
                        <input id="userName" name="userName" placeholder="请输入姓名" class="form-control" type="text" maxlength="30" required>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">身份证号：</label>
                    <div class="col-sm-8">
                        <input id="idNumber"  name="idNumber" placeholder="请输入身份证号" class="form-control" type="text" required>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">电子邮箱：</label>
                    <div class="col-sm-8">
                        <input id="email" name="email" class="form-control email" type="text" maxlength="20" placeholder="请输入邮箱">
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">手机号码：</label>
                    <div class="col-sm-8">
                        <input id="phoneNumber" name="phoneNumber" placeholder="请输入手机号码" class="form-control" type="text" maxlength="11">
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">用户性别：</label>
                    <div class="col-sm-8">
                        <select name="sex" class="form-control m-b" required>
                            <option value="0">男</option>
                            <option value="1">女</option>
                            <option value="2">未知</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">生成学籍：</label>
                    <div class="col-sm-8">
                        <label class="toggle-switch switch-solid">
                            <input type="checkbox" id="isSchoolRoll" name="isSchoolRoll">
                            <span></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">家庭住址：</label>
                    <div class="col-xs-10">
                        <label>
                            <select name="province" id="province" class="form-control m-b address">
                                <option value=''>请选择省</option>
                            </select>
                        </label>
                        <label>
                            <select name="city" id="city" class="form-control m-b address">
                                <option value=''>请选择市</option>
                            </select>
                        </label>
                        <label>
                            <select name="area" id="area" class="form-control m-b address">
                                <option value=''>请选择县/区</option>
                            </select>
                        </label>
                        <label>
                            <select name="street" id="street" class="form-control m-b address">
                                <option value=''>请选择镇/乡</option>
                            </select>
                        </label>
                        <label>
                            <select name="villages" id="villages" class="form-control m-b address">
                                <option value=''>请选择村</option>
                            </select>
                        </label>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <h4 class="form-header h4">其他信息</h4>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-xs-2 control-label">备注：</label>
                    <div class="col-xs-10">
                        <textarea name="remark" maxlength="500" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<th:block th:include="include :: footer" />
<th:block th:include="include :: bootstrap-select-js" />
<script th:inline="javascript">
    var prefix = ctx + "user";

    $(function () {
        $(".address").selectpicker({
            "width": 200,
            "virtualScroll": 10,
            "liveSearch": true,
            "size": 10
        })
        $(function () { $("[data-toggle='tooltip']").tooltip(); });
        selectRender("province", 0, "请选择省");
    });
    
    function clearSelect(num) {
        var selects = [
            {id: "city", text: "请选择市"}, {id: "area", text: "请选择县/区"},{id: "street", text: "请选择镇/乡"},
            {id: "villages", text: "请选择村"},
        ];
        for(var i = num; i < selects.length; i++){
            var _this = $("#" + selects[i].id);
            _this.html("");
            _this.append("<option value=''>" + selects[i].text + "</option>");
            _this.selectpicker("refresh");
        }
    }

    function selectRender(id, addressId, text) {
        if($.common.isEmpty(addressId)){
            return ;
        }
        var _this = $("#" + id);
        $.post(ctx + "address/selectProvince/" + addressId, function(data){
            for(var i=0; i< data.length;i++){
                _this.append("<option value='"+data[i].addressId+"'>"+data[i].addressName+"</option>");
            }
            _this.selectpicker("refresh");
        });
    }

    $('#province').on('changed.bs.select', function () {
        clearSelect(0);
        selectRender("city", $("#province option:selected").val(), "请选择市");
    });
    $('#city').on('changed.bs.select', function () {
        clearSelect(1);
        selectRender("area", $("#city option:selected").val(), "请选择县/区");
    });
    $('#area').on('changed.bs.select', function () {
        clearSelect(2);
        selectRender("street", $("#area option:selected").val(), "请选择镇/乡");
    });
    $('#street').on('changed.bs.select', function () {
        clearSelect(3);
        selectRender("villages", $("#street option:selected").val(), "请选择村");
    });

    $("#form-user-add").validate({
        onkeyup: false,
        rules:{
            loginName:{
                minlength: 2,
                maxlength: 20,
                remote: {
                    url: prefix + "/checkLoginNameUnique",
                    type: "post",
                    dataType: "json",
                    data: {
                        "loginName": function() {
                            return $.common.trim($("#loginName").val());
                        }
                    },
                    dataFilter: function(data, type) {
                        return $.validate.unique(data);
                    }
                }
            },
            password:{
                minlength: 5,
                maxlength: 20
            },
            email:{
                email:true
            },
            phoneNumber:{
                isPhone:true
            },
            idNumber:{
                isIdentity:true,
                minlength: 2,
                maxlength: 20,
                remote: {
                    url: prefix + "/checkIdNumberUnique",
                    type: "post",
                    dataType: "json",
                    data: {
                        "idNumber": function() {
                            return $.common.trim($("#idNumber").val());
                        }
                    },
                    dataFilter: function(data, type) {
                        return $.validate.unique(data);
                    }
                }
            }
        },
        messages: {
            "loginName": {
                remote: "用户已经存在"
            },
            "idNumber": {
                remote: "该学生信息已在库"
            }
        },
        focusCleanup: true
    });

    function submitHandler() {
        var addressIds = ["#villages", "#street", "#area","#city", "#province"]
        for(var i=0; i < addressIds.length; i++){
            if($.common.isNotEmpty($(addressIds[i] + " option:selected").val())){
                $("#address").val($(addressIds[i] + " option:selected").val());
                break;
            }
        }

        if ($.validate.form()) {
            var data = $("#form-user-add").serializeArray();
            var isSchoolRoll = $("input[id='isSchoolRoll']").is(':checked') == true ? true : false;
            data.push({"name": "isSchoolRoll", "value": isSchoolRoll});
            data.push({"name": "schoolId", "value": parent.$("#schoolId").val()});
            data.push({"name": "gradeId", "value": parent.$("#gradeId").val()});
            data.push({"name": "classId", "value": parent.$("#classId").val()});
            $.operate.save(ctx + "info/student/add", data);
        }
    }

</script>
</body>
</html>